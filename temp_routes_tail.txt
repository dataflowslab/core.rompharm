@router.delete("/purchase-orders/{order_id}/attachments/{attachment_id}")
async def delete_attachment(
    request: Request,
    order_id: str,
    attachment_id: str,
    current_user: dict = Depends(verify_token)
):
    """Delete an attachment from a purchase order"""
    from modules.depo_procurement.services import delete_order_attachment
    return await delete_order_attachment(attachment_id)


@router.get("/purchase-orders/{order_id}/qc-records")
async def get_qc_records_endpoint(
    request: Request,
    order_id: str,
    current_user: dict = Depends(verify_token)
):
    """Get QC records for a purchase order"""
    from modules.depo_procurement.services import get_qc_records
    return await get_qc_records(order_id)


@router.post("/purchase-orders/{order_id}/qc-records")
async def create_qc_record_endpoint(
    request: Request,
    order_id: str,
    current_user: dict = Depends(verify_token)
):
    """Create a new QC record for a purchase order"""
    from modules.depo_procurement.services import create_qc_record
    body = await request.json()
    return await create_qc_record(order_id, body, current_user)


@router.patch("/purchase-orders/{order_id}/qc-records/{qc_id}")
async def update_qc_record_endpoint(
    request: Request,
    order_id: str,
    qc_id: str,
    current_user: dict = Depends(verify_token)
):
    """Update a QC record"""
    from modules.depo_procurement.services import update_qc_record
    body = await request.json()
    return await update_qc_record(order_id, qc_id, body, current_user)
    
# ==================== APPROVAL FLOW ENDPOINTS ====================

@router.get("/purchase-orders/{order_id}/approval-flow")
async def get_approval_flow_endpoint(
    request: Request,
    order_id: str,
    current_user: dict = Depends(verify_token)
):
    """Get approval flow for a purchase order"""
    from modules.depo_procurement.services import get_order_approval_flow
    return await get_order_approval_flow(order_id)


@router.post("/purchase-orders/{order_id}/approval-flow")
async def create_approval_flow_endpoint(
    request: Request,
    order_id: str,
    current_user: dict = Depends(verify_token)
):
    """Create approval flow for a purchase order using approval_templates"""
    from modules.depo_procurement.services import create_order_approval_flow
    return await create_order_approval_flow(order_id)


@router.post("/purchase-orders/{order_id}/sign")
async def sign_order_endpoint(
    request: Request,
    order_id: str,
    current_user: dict = Depends(verify_token)
):
    """Sign a purchase order approval flow"""
    from modules.depo_procurement.services import sign_purchase_order
    body = await request.json()
    action = body.get('action', 'issue')
    return await sign_purchase_order(
        order_id, action, current_user, 
        request.client.host, request.headers.get("user-agent")
    )


@router.delete("/purchase-orders/{order_id}/signatures/{user_id}")
async def remove_signature_endpoint(
    request: Request,
    order_id: str,
    user_id: str,
    current_user: dict = Depends(verify_token)
):
    """Remove signature from purchase order approval flow (admin only)"""
    from modules.depo_procurement.services import remove_order_signature
    return await remove_order_signature(order_id, user_id, current_user)


#
